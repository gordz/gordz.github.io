<!DOCTYPE html>
<html>
    <head>
        <title>Start Page</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script type="text/javascript" src="js/trig.js"></script>
        <script type="text/javascript" src="js/shapes.js"></script>
        <script type="text/javascript" src="js/gameObjects.js"></script>
    </head>
    <body>
    	<header><h1>Header section</h1></header>
        <canvas id="canvas" width="1000" height="1000">
        </canvas>
        
        <script type="text/javascript">       	
        
        	var drawGrid = function(strokeStyle) {
    			const spacing = 20;
        		this.stokeStyle = strokeStyle;
        		
        		// Draw y axis.
        		this.beginPath();
        		for (var i = 0; i < canvas.width / spacing; i++) {
        			// Move drawing cursor to x,y.
        			this.moveTo(0 + (i * spacing), 0);
        			// Draw line to x, y
        			this.lineTo(0 + (i * spacing), this.canvas.height);
        		}
        		
        		// Draw x axis
        		for (var i = 0; i < canvas.height / spacing; i++) {
        			// Move drawing cursor to x,y.
        			this.moveTo(0, 0 + (i * spacing));
        			// Draw line to x, y
        			this.lineTo(this.canvas.width, 0 + (i * spacing));
        		}
     			this.stroke();
    			this.closePath();
        	}
        	
        	
        	function randomInteger(min, max) {
        		return min + Math.floor((max - min) * Math.random());
        	}

        	function drawGround() {
        		// Fill with a gradient.
        		var gradient = context.createLinearGradient(0, 700, context.canvas.width, context.canvas.height);
        		gradient.addColorStop(0, '#009900')
        		gradient.addColorStop(0.25, '#336600');
        		gradient.addColorStop(0.50, '#7A5229');
        		gradient.addColorStop(0.75,'#493119');
   				context.fillStyle = gradient;
        		context.fillRect(0, 700, context.canvas.width, context.canvas.height);
        	}
        	
        	
        	function drawSky(context) {
        		context.fillStyle = "#0099FF";	//sky blue.
        		context.fillRect(0, 0, context.canvas.width, context.canvas.height);
        	}
        	
        	/*
        	function drawGround(context) {
        		drawHorizontalRandomJagged(context, 600, 940, 40, 50);
        	}
        	*/
        	
      		
        	
   
        	// Draw a 3 colour flag.
        	var drawFlag = function(x, y, colour1, colour2, colour3) {
        		this.fillStyle = colour1;
        		this.fillRect(x, y, 20, 80);
        		
        		this.fillStyle = colour2;
        		this.fillRect(x + 20, y, 20, 80);
        		
        		this.fillStyle = colour3;
        		this.fillRect(x + 40, y, 20, 80);
        	}
        	
        	

        	var canvas = document.getElementById("canvas");
        	
        	// Get a CanvasRenderingContext2D.
        	var context = canvas.getContext("2d");

        	
        	// Draw a rectangle.
        	//context.fillStyle = "black";
        	// X, Y, width, height
        	//context.fillRect (1,9,400,400);
        	canvas.onclick = function(event) {
        		fireSmallBullet(event);
        	}
        	
        	
        	var explosions = [];
        	
        	function fireBullet(event) {
        		var x = event.clientX - canvas.offsetLeft;
        		var y = event.clientY - canvas.offsetTop;
        		
        	    y += document.documentElement.scrollTop;
        	    
        		context.beginPath();
        		context.moveTo(0, 400);
        		context.lineTo(x, y);
        		context.stroke();
        		
        		// Draw explosion
        		explosions.push(new Explosion({x: x, y: y}, 60));
        	}

        	
        	var bullets = [];
        	
        	function fireSmallBullet(event) {
        		var x = event.clientX - canvas.offsetLeft;
        		var y = event.clientY - canvas.offsetTop;
        		
        	    y += document.documentElement.scrollTop;
        	    
        	    bullets.push(new SmallBullet({x: 500, y: 700}, {x: x, y: y}));
        	}
   	
  function drawSun() {
	  var rg = context.createRadialGradient (80, 80, 20, 120, 120, 110);
	  // 2. add colors
	  rg.addColorStop (0, 'yellow');
	  rg.addColorStop (1, 'red');
	  // 3. set the fill style to the new gradient
	  context.fillStyle = rg;
	  // 4. now draw some filled objects; in this case just a circle
	  context.beginPath();
	  context.arc (120,120,110,0,2*Math.PI,false);
	  context.fill();
	  context.closePath();
  }      	

  
  // Shim -> get function responsible for animation.
  var requestAnimationFrame = window.requestAnimationFrame ||
  window.mozRequestAnimationFrame ||
  window.webkitRequestAnimationFrame ||
  window.msRequestAnimationFrame;
  
  //context.clearRect(0,0, context.canvas.width, context.canvas.height);
  var x = 30;
  var y = 30;
  var now = new Date();
  var millis = now.getTime();
  var count = 0;
  
  var start = new Date();
  var lastDraw = null;
  
  
  var totalDistance = 0;

  function Emp(startCoord) {
	  
	  var spawned = new Date();
	  var speed = 700;
	  var alive = true;
	  var centre = startCoord;
	  var radius = 0;
	  
	  this.updatePosition = function(time) {
		  if (alive) {
		  	this.radius = speed * ((time - spawned.getTime()) / 1000);
		  	context.beginPath();
		  	context.arc(startCoord.x, startCoord.y, this.radius, 0, 2 * Math.PI, true);
		  	context.stroke();
		  }
		  
	  }
	  
	  this.hasCollided = function(missile) {
	  	if (alive) {
        		var missilePosition = missile.currentPosition;
        		var distanceToMissile = Trig.hypot((missilePosition.x - centre.x), (missilePosition.y - centre.y));
        		if (distanceToMissile <= this.radius) {
        			return true;
        		}
	  	}
	}
  	}
  
 
/*  var emps = []
  for (i = 0; i < 1; i++) {
	  emps.push(new Emp({x: 500, y: 700}));
  }
  */
  var aaEmplacements = [];
  for (var i = 0; i < 2 ; i++) {
	  aaEmplacements.push(new AAEmplacement({x: 300, y:800}));
  }
  
  
  var missiles = [];
  for (var i = 0; i < 10; i++) {
	  missiles.push(new Missile({x: randomInteger(0, context.canvas.width), y: 0}));
  }
  
  for (var i = 0; i < 0; i++) {
	  missiles.push(new Mirv({x: randomInteger(0, context.canvas.width), y: 0}));
  }


  function detectCollissions(explosions, missiles, bases) {
	  missiles.forEach(function (missile) {
		  explosions.forEach(function (explosion) {
			  if (explosion.hasCollided(missile)) {
					 missile.destroy();
		      }
		  });
		  
		  if (missile.currentPosition.y >= 700) {
			  animate = false;
			  alert("You died");
		  }
		  /*
		  emps.forEach(function(emp) {
			 if (emp.hasCollided(missile)) {
				 missile.destroy();
			 } 
		  });
		  */
	  });
  }
  
  var startTime;
  var animate = true;
  
  function draw(time) {
	  
	  if (animate) {
	  context.clearRect(0, 0, context.canvas.width, context.canvas.height);
	  
	  drawBackground();
	  
	  if (!startTime) {
		  startTime = time;
	  }
	  
	  missiles.forEach(function(missile) {
		  missile.updatePosition(time);
	  });
	  
	  explosions.forEach(function(explosion) {
		  explosion.updatePosition(time);
	  });
	  
	  /*
	  aaEmplacements.forEach(function(aaEmplacement) {
		  aaEmplacement.updatePosition(time);
	  });
	  */
	  
	  bullets.forEach(function(bullet) {
		  bullet.updatePosition(time);
	  });
	  
	  /*
	  emps.forEach(function(emp) {
		emp.updatePosition(time);  
	  });
	  */
	  
	 
	  //context.beginPath();
	 // context.arc(500, 500, 3, 0, 2 * Math.PI, true);
	  //context.fill();
	  
	  detectCollissions(explosions, missiles);
	  
      requestAnimationFrame(draw);

  	// console.log("Number of explosions: " + explosions.length);
  	 
  	 // Clear up objects every 2 seconds.
  		  explosions = explosions.filter(function(explosion) {
  			  if (explosion.isAlive()) {
  				  return true;
  			  }
  			  return false;
  		  });
  	 
  	 
  		  missiles = missiles.filter(function(missile) {
  			  if (missile.isAlive()) {
  				  return true;
  			  }
  			  return false;
  		  });
	  }
  }
  
  requestAnimationFrame(draw);
  
 
 var background;
 
 function drawBackground() {
	 if (background != null || background != undefined) {
		 context.putImageData(background, 0, 0, context.canvas.width, context.canvas.height);
	 } else {
		 drawSky(context);
		 drawGround(context);
		 drawSun();
	 	 background = context.getImageData(0, 0, context.canvas.width, context.canvas.height);
	 } 	 
 }

        </script>
        <footer>Footer section</footer>
    </body>
</html>
